<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Home Finance Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, where, orderBy,
      serverTimestamp, doc, deleteDoc, updateDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { firebaseConfig } from "./firebase-config.js";

    /* === Config === */
    const CATS = ["Salud","Comida","Casa","Gatas","Uber Eats","Otros"];
    const PAYERS = ["Miguelito","Josefita"];
    const SAVING_TYPES = ["Fondos Mutuos"];

    // Currency formatting (CLP)
    const fmt = (n) =>
      new Intl.NumberFormat("es-CL", { style: "currency", currency: "CLP", maximumFractionDigits: 0 }).format(Number(n)||0);

    /* === Firebase === */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* === Elements === */
    const loginView = document.getElementById("login-view");
    const dashboardView = document.getElementById("dashboard-view");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const loginBtn = document.getElementById("login-btn");
    const registerBtn = document.getElementById("register-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const authHelp = document.getElementById("auth-help");

    // Tabs
    const tabFin = document.getElementById("tab-fin");
    const tabSav = document.getElementById("tab-sav");
    const tabMon = document.getElementById("tab-mon");
    const tabInst = document.getElementById("tab-inst");
    const pageFin = document.getElementById("page-fin");
    const pageSav = document.getElementById("page-sav");
    const pageMon = document.getElementById("page-mon");
    const pageInst = document.getElementById("page-inst");

    // Finance
    const form = document.getElementById("tx-form");
    const txTableBody = document.getElementById("tx-tbody");
    const monthSelect = document.getElementById("month-select");
    const totalEl = document.getElementById("total");
    const incomeEl = document.getElementById("income");
    const expenseEl = document.getElementById("expense");
    const catChartCanvas = document.getElementById("catChart");
    const catSelect = document.getElementById("category");
    const payerSelect = document.getElementById("payer");
    const typeSelect = document.getElementById("tx-type");

    const installmentsToggle = document.getElementById("with-installments");
    const installmentsBox = document.getElementById("installments-box");
    // New vs Existing plan
    const planMode = document.getElementById("plan-mode");
    const newPlanBox = document.getElementById("new-plan-box");
    const existingPlanBox = document.getElementById("existing-plan-box");

    // Permanentes & Sueldos
    const permList = document.getElementById("perm-list");
    const permName = document.getElementById("perm-name");
    const permAmount = document.getElementById("perm-amount");
    const permCategory = document.getElementById("perm-category");
    const permAddBtn = document.getElementById("perm-add");

    const salList = document.getElementById("sal-list");
    const salName = document.getElementById("sal-name");
    const salAmount = document.getElementById("sal-amount");
    const salPayer = document.getElementById("sal-payer");
    const salAddBtn = document.getElementById("sal-add");

    // Finance read-only savings
    const financeSavings = document.getElementById("finance-savings");

    // Savings tab
    const savForm = document.getElementById("sav-form");
    const savOwner = document.getElementById("sav-owner");
    const savType  = document.getElementById("sav-type");
    const savAmount = document.getElementById("sav-amount");
    const savDate = document.getElementById("sav-date");
    const savTable = document.getElementById("sav-table");
    const savSummary = document.getElementById("sav-summary");

    // Monthly summary
    const monWrap = document.getElementById("monthly-wrap");
    const monStats = document.getElementById("monthly-stats");

    // Installments analysis
    const instWrap = document.getElementById("inst-wrap");

    // Person summaries (add permanents box per column)
    const sumMigNo = document.getElementById("sum-mig-no");
    const sumMigYes = document.getElementById("sum-mig-yes");
    const sumMigMini = document.getElementById("sum-mig-mini");
    const sumPermA = document.getElementById("sum-perm-a");
    const sumJosNo = document.getElementById("sum-jos-no");
    const sumJosYes = document.getElementById("sum-jos-yes");
    const sumJosMini = document.getElementById("sum-jos-mini");
    const sumPermB = document.getElementById("sum-perm-b");

    // Pie
    const spendPieCanvas = document.getElementById("spendPie");
    let spendPie = null;
    const existingPlanSelect = document.getElementById("existing-plan-select");


    // Global
    const globalSummary = document.getElementById("global-summary");

    // Toast
    const toast = document.getElementById("toast");
    const showToast = (msg) => { toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 800); };

    /* === State === */
    let unsubTx = null, unsubPerm = null, unsubSal = null, unsubSav = null;
    let catChart = null, currentUser = null;
    let txRows = [], permanents = [], salaries = [], savings = [];

    /* === Helpers === */
    const monthKeyFromDate = (d)=>{ const dt=new Date(d); return isFinite(dt)? `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}` : ""; };
    const addMonths = (date, m)=>{ const d=new Date(date); d.setMonth(d.getMonth()+m); return d; };
    const firstDayOfMonthKey = (k)=>{ const [y,m]=k.split("-").map(Number); return new Date(y,m-1,1); };
    const fillSelect = (sel, arr)=>{ sel.innerHTML=""; arr.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); }); };
    const populateMonths = ()=>{
      monthSelect.innerHTML="";
      const now=new Date();
      for(let i=-6;i<=6;i++){ const dt=new Date(now.getFullYear(), now.getMonth()+i, 1);
        const key=monthKeyFromDate(dt); const opt=document.createElement("option"); opt.value=key; opt.textContent=key; if(i===0) opt.selected=true; monthSelect.appendChild(opt);
      }
    };
    const progressMeta = (idx,count)=>{
      const pct = Math.max(0, Math.min(100, Math.round((idx/count)*100)));
      const tone = pct<40?"red":(pct<80?"amber":"green");
      return {pct, tone};
    };
    const safeDate = (x)=>{
      const d = x?.toDate?.() ? x.toDate() : new Date(x);
      return isFinite(d) ? d : null;
    };

    /* === Auth === */
    loginBtn.addEventListener("click", async ()=>{ try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value.trim()); }catch(e){ alert(e.message); }});
    registerBtn.addEventListener("click", async ()=>{ try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value.trim()); showToast("Usuario creado"); }catch(e){ alert(e.message); }});
    logoutBtn.addEventListener("click", async ()=>{ try{ await signOut(auth); }catch(e){ alert(e.message); }});
    const show = (v)=>{ loginView.style.display = v==="login"?"block":"none"; dashboardView.style.display = v==="dashboard"?"block":"none"; };

    /* === Tabs === */
    const tabs = [
      {btn:tabFin, page:pageFin, key:"fin"},
      {btn:tabSav, page:pageSav, key:"sav"},
      {btn:tabMon, page:pageMon, key:"mon"},
      {btn:tabInst,page:pageInst,key:"inst"},
    ];
    const activateTab = (key)=>{
      tabs.forEach(t=>{ t.btn.classList.remove("active"); t.page.classList.remove("active"); });
      const t = tabs.find(x=>x.key===key); if(!t) return;
      t.btn.classList.add("active"); t.page.classList.add("active");
      if(key==="fin"){ renderFinanceSavings(); }
      if(key==="mon"){ renderMonthlySummary(); }
      if(key==="inst"){ renderInstallmentAnalysis(); }
    };
    tabs.forEach(t=> t.btn.addEventListener("click", ()=>activateTab(t.key)));

    /* === Firestore subs === */
    function subTx(){
      if(!currentUser) return; if(unsubTx) unsubTx();
      const q1 = query(collection(db,"transactions"),
        where("uid","==",currentUser.uid),
        where("month","==",monthSelect.value),
        orderBy("date"));
      unsubTx = onSnapshot(q1, snap=>{
        txRows=[]; let income=0, expense=0; const catAggTx={};
        snap.forEach(d=>{
          const t=d.data(); t._id=d.id; txRows.push(t);
          const amt=Number(t.amount)||0;
          if(amt>=0) income+=amt; else expense+=Math.abs(amt);
          const c=t.category||"Otros";
          if (amt<0) catAggTx[c]=(catAggTx[c]||0)+Math.abs(amt); // only expense for chart from tx
        });
        // Combine with permanents/salaries for KPIs/chart
        renderMonthKpisAndChart(catAggTx);
        renderMainTable(txRows);
        renderSummaries();
        renderFinanceSavings();
      });
    }
    function subPerm(){ if(!currentUser) return; if(unsubPerm) unsubPerm();
      const q1=query(collection(db,"permanents"), where("uid","==",currentUser.uid), orderBy("name"));
      unsubPerm=onSnapshot(q1, snap=>{ permanents=[]; snap.forEach(d=>{ const p=d.data(); p._id=d.id; permanents.push(p); }); renderPermanents(); renderMonthKpisAndChart(); renderSummaries(); });
    }
    function subSal(){ if(!currentUser) return; if(unsubSal) unsubSal();
      const q1=query(collection(db,"salaries"), where("uid","==",currentUser.uid), orderBy("name"));
      unsubSal=onSnapshot(q1, snap=>{ salaries=[]; snap.forEach(d=>{ const p=d.data(); p._id=d.id; salaries.push(p); }); renderSalaries(); renderMonthKpisAndChart(); renderSummaries(); });
    }
    function subSav(){ if(!currentUser) return; if(unsubSav) unsubSav();
  const q1=query(collection(db,"savings"), where("uid","==",currentUser.uid), orderBy("date"));
  unsubSav=onSnapshot(q1, snap=>{
    savings=[]; snap.forEach(d=>{ const s=d.data(); s._id=d.id; savings.push(s); });
    renderSavingsTab();
    renderFinanceSavings();
    renderMonthKpisAndChart();   // ← add this
    renderSummaries();           // ← and this (balances)
    renderMonthlySummary();      // ← and this (3-month view)
  });
}


    /* === Month KPIs + Chart (now includes permanents & salaries) === */
    function renderMonthKpisAndChart(existingCatAggTx = {}) {
  const selKey = monthSelect.value;
  const monthDate = firstDayOfMonthKey(selKey);

  // Synthetic permanents (negative) & salaries (positive)
  const permRows = permanents.map(p=>({ amount:Number(p.amount)||0, category:p.category||"Otros", payee:p.name||"Permanente", _dt:mDate }));
const salRows  = salaries.map(p=>({ amount:Math.abs(Number(p.amount)||0), category:"Sueldo", payee:p.name||"Sueldo", _dt:mDate }));

// NEW: savings for this month key — deposits (+) are expense, withdrawals (-) are income
const savRows  = savings
  .filter(s=> monthKeyFromDate(safeDate(s.date)) === key )
  .map(s=> ({ amount:Number(s.amount)||0, category:"Ahorros", payee:`Ahorro ${s.owner}`, _dt:safeDate(s.date) || mDate }));

const full = [...arr, ...permRows, ...salRows, ...savRows];


  // KPIs
  let income = 0, expense = 0;

  // transactions already signed by type
  txRows.forEach(t => { const a=Number(t.amount)||0; if(a>=0) income+=a; else expense+=Math.abs(a); });
  // salaries add to income
  salRows.forEach(s => income += Number(s.amount)||0);
  // permanents add to expense
  permRows.forEach(p => expense += Math.abs(Number(p.amount)||0));
  // savings: deposits (a>0) are expense; withdrawals (a<0) are income
    savRows.forEach(s=>{
      const a = Number(s.amount)||0;
      if (a > 0) expense += a;        // deposit → money out
      else if (a < 0) income += -a;   // withdrawal → money in
    });

  incomeEl.textContent = fmt(income);
  expenseEl.textContent = fmt(-expense);
  totalEl.textContent = fmt(income - expense);

  // Category chart: expense-only, include permanents and savings (deposits)
  const catAgg = { ...existingCatAggTx }; // tx negatives already added upstream
  permRows.forEach(p=>{
    const cat=p.category||"Otros";
    catAgg[cat]=(catAgg[cat]||0)+Math.abs(Number(p.amount)||0);
  });
  savRows.filter(s=>s.amount>0).forEach(s=>{
    catAgg["Ahorros"] = (catAgg["Ahorros"]||0) + s.amount;
  });

  const labels = Object.keys(catAgg), data = Object.values(catAgg);
  if (catChart) catChart.destroy();
  catChart = new Chart(catChartCanvas,{
    type:"bar",
    data:{ labels, datasets:[{ label:"Gasto por categoría", data }] },
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>fmt(v) } } } }
  });

  // Spend pie: savings, permanentes, Miguelito tx, Josefita tx
  const txNegMig = txRows.filter(r=>r.payer==="Miguelito" && Number(r.amount)<0).reduce((s,x)=>s+Math.abs(Number(x.amount)),0);
  const txNegJos = txRows.filter(r=>r.payer==="Josefita" && Number(r.amount)<0).reduce((s,x)=>s+Math.abs(Number(x.amount)),0);
  const permTot = permRows.reduce((s,x)=>s+Math.abs(Number(x.amount)),0);
  const savDep = savRows.filter(s=>s.amount>0).reduce((s,x)=>s+Number(x.amount),0);

  const pieLabels = ["Ahorros","Permanentes","Miguelito (tx)","Josefita (tx)"];
  const pieData = [savDep, permTot, txNegMig, txNegJos];

  if (spendPie) spendPie.destroy();
spendPie = new Chart(spendPieCanvas, {
  type:"doughnut",
  data:{ labels: pieLabels, datasets:[{ data: pieData }] },
  options:{
    responsive:true,
    maintainAspectRatio:true,
    radius: "65%",
    cutout: "55%",
    plugins:{
      legend:{ position:"bottom", labels:{ boxWidth:10, usePointStyle:true } },
      tooltip:{ callbacks:{ label: (ctx)=> `${ctx.label}: ${fmt(ctx.parsed)}` } }
    }
  }
});

    /* === Render finance === */
    function renderMainTable(rows){
      txTableBody.innerHTML="";
      rows.forEach(r=>{
        const tr=document.createElement("tr"); tr.dataset.id=r._id;
        const d0 = safeDate(r.date);
        const dateStr = d0? d0.toISOString().slice(0,10) : "";
        const amt=Number(r.amount||0);
        const ip=r.installmentPlan;
        const prog = ip ? progressMeta(ip.index||1, ip.count||1) : null;
        const ipHtml = ip ? `
          <div class="chip-row">
            <span class="i-chip ${prog.tone}">Cuota ${ip.index}/${ip.count}</span>
            <span class="i-chip">${ip.planId||"plan"}</span>
            <span class="progress"><span style="width:${prog.pct}%"></span></span>
          </div>` : "";
        tr.innerHTML=`
          <td contenteditable="true" data-field="date">${dateStr}</td>
          <td contenteditable="true" data-field="payee">${r.payee||""}${ipHtml}</td>
          <td contenteditable="true" data-field="category">${r.category||""}</td>
          <td contenteditable="true" data-field="amount" class="${amt<0?'neg':'pos'}">${amt}</td>
          <td contenteditable="true" data-field="payer">${r.payer||""}</td>
          <td contenteditable="true" data-field="notes">${r.notes||""}</td>
          <td><button class="mini danger" data-action="delete">Eliminar</button><button class="mini" data-action="save">Guardar</button></td>`;
        txTableBody.appendChild(tr);
      });
      txTableBody.querySelectorAll("button[data-action='delete']").forEach(b=>{
        b.addEventListener("click", async e=>{
          const tr=e.target.closest("tr"); const id=tr.dataset.id;
          if(!confirm("¿Eliminar transacción?")) return;
          try{ await deleteDoc(doc(db,"transactions",id)); showToast("Transacción eliminada"); }catch(err){ alert(err.message); }
        });
      });
      txTableBody.querySelectorAll("button[data-action='save']").forEach(b=>{
        b.addEventListener("click", async e=>{
          const tr=e.target.closest("tr"); const id=tr.dataset.id; const payload={};
          tr.querySelectorAll("[data-field]").forEach(cell=>{
            const f=cell.dataset.field; let v=cell.textContent.trim();
            if(f==="amount") v=Number(v);
            if(f==="date"){ const d=new Date(v); if(isFinite(d)) { payload.date=d; payload.month=monthKeyFromDate(d); } }
            else payload[f]=v;
          });
          try{ await updateDoc(doc(db,"transactions",id), payload); showToast("Transacción guardada"); }catch(err){ alert(err.message); }
        });
      });
    }

    function renderPermanents(){
      permList.innerHTML="";
      if(!permanents.length){ permList.innerHTML='<p class="subtle">No hay gastos permanentes. Agrega uno abajo.</p>'; return; }
      const grid=document.createElement("div"); grid.className="perms-grid";
      permanents.forEach(p=>{
        const c=document.createElement("div"); c.className="perm-card";
        c.innerHTML=`
          <div class="section-title"><b>${p.name||"(Sin nombre)"} </b><span class="badge red">Permanente</span></div>
          <label>Monto mensual (gasto)
            <input type="number" data-f="amount" value="${Math.abs(Number(p.amount)||0)}">
          </label>
          <label>Categoría <select data-f="category"></select></label>
          <div class="row"><button class="mini" data-action="save" data-id="${p._id}">Guardar</button><button class="mini danger" data-action="delete" data-id="${p._id}">Eliminar</button></div>`;
        const catSel=c.querySelector('select[data-f="category"]'); fillSelect(catSel, CATS);
        if(p.category) catSel.value=p.category;
        grid.appendChild(c);
      }); permList.appendChild(grid);

      permList.querySelectorAll("button[data-action='save']").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id=btn.getAttribute("data-id"); const root=btn.closest(".perm-card");
          const amount=-Math.abs(Number(root.querySelector('input[data-f="amount"]').value||0));
          const category=root.querySelector('select[data-f="category"]').value;
          try{ await updateDoc(doc(db,"permanents",id), {amount,category}); showToast("Permanente guardado"); }catch(e){ alert(e.message); }
        });
      });
      permList.querySelectorAll("button[data-action='delete']").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id=btn.getAttribute("data-id"); if(!confirm("¿Eliminar gasto permanente?")) return;
          try{ await deleteDoc(doc(db,"permanents",id)); showToast("Permanente eliminado"); }catch(e){ alert(e.message); }
        });
      });
    }

    function renderSalaries(){
      salList.innerHTML="";
      if(!salaries.length){ salList.innerHTML='<p class="subtle">No hay sueldos. Agrega uno abajo.</p>'; return; }
      const grid=document.createElement("div"); grid.className="perms-grid";
      salaries.forEach(p=>{
        const c=document.createElement("div"); c.className="perm-card";
        c.innerHTML=`
          <div class="section-title"><b>${p.name||"Sueldo"}</b> <span class="badge green">Sueldo</span></div>
          <label>Monto mensual (ingreso)
            <input type="number" data-f="amount" value="${Math.abs(Number(p.amount)||0)}">
          </label>
          <label>Persona <select data-f="payer"></select></label>
          <div class="row"><button class="mini" data-action="save" data-id="${p._id}">Guardar</button><button class="mini danger" data-action="delete" data-id="${p._id}">Eliminar</button></div>`;
        const paySel=c.querySelector('select[data-f="payer"]'); fillSelect(paySel, PAYERS); if(p.payer) paySel.value=p.payer;
        grid.appendChild(c);
      }); salList.appendChild(grid);

      salList.querySelectorAll("button[data-action='save']").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id=btn.getAttribute("data-id"); const root=btn.closest(".perm-card");
          const amount=Math.abs(Number(root.querySelector('input[data-f="amount"]').value||0));
          const payer=root.querySelector('select[data-f="payer"]').value;
          try{ await updateDoc(doc(db,"salaries",id), {amount,payer}); showToast("Sueldo guardado"); }catch(e){ alert(e.message); }
        });
      });
      salList.querySelectorAll("button[data-action='delete']").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id=btn.getAttribute("data-id"); if(!confirm("¿Eliminar sueldo?")) return;
          try{ await deleteDoc(doc(db,"salaries",id)); showToast("Sueldo eliminado"); }catch(e){ alert(e.message); }
        });
      });
    }

    function rowInstallmentDecor(r){
      const ip=r.installmentPlan; if(!ip) return "";
      const {pct,tone}=progressMeta(ip.index||1, ip.count||1);
      return `
        <div class="chip-row" style="margin-top:4px">
          <span class="i-chip ${tone}">Cuota ${ip.index}/${ip.count}</span>
          <span class="i-chip">${ip.planId||"plan"}</span>
          <span class="progress"><span style="width:${pct}%"></span></span>
        </div>`;
    }

    function renderSimpleTable(container, rows, title, decorateCuotas=false){
      const tot = rows.reduce((s,x)=>s+Number(x.amount||0),0);
      container.innerHTML=`
        <details open>
          <summary>${title} — <span class="badge">Total: ${fmt(tot)}</span></summary>
          <div class="table-wrap">
            <table>
              <thead class="sticky-head"><tr><th>Fecha</th><th>Payee</th><th>Categoría</th><th>Monto</th><th>Notas</th></tr></thead>
              <tbody>
                ${rows.map(r=>{
                  const d=safeDate(r.date); const ds=d? d.toISOString().slice(0,10) : "";
                  const amt=Number(r.amount||0);
                  const deco = decorateCuotas ? rowInstallmentDecor(r) : "";
                  return `<tr>
                    <td>${ds}</td>
                    <td>${r.payee||""}${deco}</td>
                    <td>${r.category||""}</td>
                    <td class="${amt<0?'neg':'pos'}">${fmt(amt)}</td>
                    <td>${r.account||""}</td>
                    <td>${r.notes||""}</td>
                  </tr>`;
                }).join("")}
              </tbody>
            </table>
          </div>
        </details>`;
    }

    function renderPermanentsSummary(container, permRows){
      const tot = permRows.reduce((s,x)=>s+Number(x.amount||0),0);
      container.innerHTML = `
        <details open>
          <summary>Permanentes (mes) — <span class="badge red">Total: ${fmt(tot)}</span></summary>
          <div class="table-wrap">
            <table>
              <thead class="sticky-head"><tr><th>Nombre</th><th>Categoría</th><th>Monto</th></tr></thead>
              <tbody>
                ${permRows.map(p=>`
                  <tr><td>${p.payee||"Permanente"}</td><td>${p.category||"Otros"}</td><td class="neg">${fmt(p.amount)}</td></tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </details>
      `;
    }

    function renderSummaries(){
      const selKey=monthSelect.value, monthDate=firstDayOfMonthKey(selKey);

      // Synthetic permanents (negative) & salaries (positive)
      const permRows = permanents.map(p=>({
        _synthetic:true, date:monthDate, month:selKey,
        amount:Number(p.amount)||0, category:p.category||"Otros", payee:p.name||"Gasto Permanente"
      }));
      const salRows = salaries.map(p=>({
        _synthetic:true, date:monthDate, month:selKey,
        amount:Math.abs(Number(p.amount)||0), category:"Sueldo", payee:p.name||"Sueldo", payer:p.payer
      }));

      // Per-person rows EXCLUDE permanents
      const rowsForPeople = [...txRows, ...salRows];
      const group = (arr, payer, cuotas) => arr.filter(r=>r.payer===payer && (!!r.installmentPlan===cuotas));
      const migNo = group(rowsForPeople,"Miguelito",false), migYes = group(rowsForPeople,"Miguelito",true);
      const josNo = group(rowsForPeople,"Josefita",false), josYes = group(rowsForPeople,"Josefita",true);

      renderSimpleTable(sumMigNo, migNo, "Miguelito · Sin cuotas (excluye permanentes)");
      renderSimpleTable(sumMigYes, migYes, "Miguelito · Con cuotas", true);
      renderPermanentsSummary(sumPermA, permRows);
      renderMini(sumMigMini, migNo, migYes, "Miguelito");

      renderSimpleTable(sumJosNo, josNo, "Josefita · Sin cuotas (excluye permanentes)");
      renderSimpleTable(sumJosYes, josYes, "Josefita · Con cuotas", true);
      renderPermanentsSummary(sumPermB, permRows);
      renderMini(sumJosMini, josNo, josYes, "Josefita");

      // Global summary INCLUDES permanents
      const tot = (a)=>a.reduce((s,x)=>s+Number(x.amount||0),0);
      const savRowsMonth = savings.filter(s=>{
        const d=safeDate(s.date); return d && monthKeyFromDate(d)===selKey;
      });
      const incomes = [...txRows, ...salRows].filter(r=>Number(r.amount)>=0).reduce((s,x)=>s+Number(x.amount),0) + savAsIncome;
      const expensesTx = txRows.filter(r=>Number(r.amount)<0).reduce((s,x)=>s+Math.abs(Number(x.amount)),0);
      const expensesPerm = permRows.reduce((s,x)=>s+Math.abs(Number(x.amount||0)),0);
      const expensesSav = savAsExpense;
      const expensesAll = expensesTx + expensesPerm + expensesSav;
      const savAsExpense = savRowsMonth.filter(s=>Number(s.amount)>0).reduce((s,x)=>s+Number(x.amount),0);
      const savAsIncome = savRowsMonth.filter(s=>Number(s.amount)<0).reduce((s,x)=>s+Math.abs(Number(x.amount)),0);

      
      const balance = incomes - expensesAll;

      globalSummary.innerHTML=`
        <table>
          <thead class="sticky-head"><tr><th>Resumen Global</th><th>Monto</th></tr></thead>
          <tbody>
            <tr><td>Ingresos (incluye sueldos y retiros de ahorro)</td><td class="pos">${fmt(incomes)}</td></tr>
            <tr><td>Gastos (transacciones)</td><td class="neg">${fmt(-expensesTx)}</td></tr>
            <tr><td>Permanentes (mes)</td><td class="neg">${fmt(-expensesPerm)}</td></tr>
            <tr><td>Ahorros (depósitos)</td><td class="neg">${fmt(-expensesSav)}</td></tr>
            <tr><td><b>Balance</b></td><td><b>${fmt(balance)}</b></td></tr>
          </tbody>
        </table>`;
      }


    function renderMini(container, noArr, yesArr, who){
  const sum = (xs)=>xs.reduce((s,x)=>s+Number(x.amount||0),0);
  const no = sum(noArr.filter(x=>Number(x.amount)<0)) * -1;      // only expenses from tx
  const yes = sum(yesArr.filter(x=>Number(x.amount)<0)) * -1;    // only expenses from tx
  const sal = salaries.filter(s=>s.payer===who).reduce((s,x)=>s+Math.abs(Number(x.amount)||0),0);
  const sav = savings.filter(s=>{
    const d=safeDate(s.date); if(!d) return false;
    return monthKeyFromDate(d)===monthSelect.value && s.owner===who && Number(s.amount)>0; // deposits only
  }).reduce((s,x)=>s+Number(x.amount),0);

  const totalOut = no + yes + sav;
  const balance = sal - totalOut;

  container.innerHTML=`
    <table>
      <thead class="sticky-head"><tr><th>${who} · Resumen</th><th>Monto</th></tr></thead>
      <tbody>
        <tr><td>Sueldos</td><td class="pos">${fmt(sal)}</td></tr>
        <tr><td>Sin cuotas (gasto)</td><td class="neg">${fmt(-no)}</td></tr>
        <tr><td>Con cuotas (gasto)</td><td class="neg">${fmt(-yes)}</td></tr>
        <tr><td>Ahorros (depósitos)</td><td class="neg">${fmt(-sav)}</td></tr>
        <tr><td><b>Balance</b></td><td><b>${fmt(balance)}</b></td></tr>
      </tbody>
    </table>`;
  }


    /* === Finance read-only savings === */
    function renderFinanceSavings(){
      const key=monthSelect.value;
      const monthOnly = savings.filter(s=>{
        const d=safeDate(s.date); if(!d) return false;
        return monthKeyFromDate(d)===key;
      });
      const sum=(w)=>monthOnly.filter(x=>x.owner===w).reduce((s,x)=>s+Number(x.amount||0),0);
      const mig=sum("Miguelito"), jos=sum("Josefita"), con=sum("Conjunto"), total=mig+jos+con;
      financeSavings.innerHTML=`
        <div class="kpis">
          <div class="kpi"><div class="kpi-label">Ahorro Miguelito (mes)</div><div class="kpi-value">${fmt(mig)}</div></div>
          <div class="kpi"><div class="kpi-label">Ahorro Josefita (mes)</div><div class="kpi-value">${fmt(jos)}</div></div>
          <div class="kpi"><div class="kpi-label">Ahorro Conjunto (mes)</div><div class="kpi-value">${fmt(con)}</div></div>
          <div class="kpi"><div class="kpi-label"><b>Total Ahorro (mes)</b></div><div class="kpi-value">${fmt(total)}</div></div>
        </div>`;
    }

    /* === Add transaction === */
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const fd=new FormData(form);
      const dateStr=fd.get("date");
      const txType=fd.get("tx-type");          // Gasto/Ingreso
      const baseAmountRaw=Number(fd.get("amount"));
      const amount = txType==="Ingreso" ? Math.abs(baseAmountRaw) : -Math.abs(baseAmountRaw);
      const d0=new Date(dateStr);

      const common = {
        uid: currentUser.uid,
        category: fd.get("category") || "Otros",
        payee: fd.get("payee") || "",
        payer: fd.get("payer") || "",
        notes: fd.get("notes") || "",
        createdAt: serverTimestamp()
      };

      try{
        const mode=fd.get("plan-mode"); // "nueva" | "existente"
        if (fd.get("with-installments") === "on") {
  const mode = fd.get("plan-mode");           // "nueva" | "existente"
  const calc = fd.get("installments-calc");   // "automatico" | "manual"

  if (mode === "existente") {
    // Add ONE installment to an existing plan
    const planId = fd.get("plan-id") || "plan";
    const idx = Number(fd.get("plan-index") || 1);
    const cnt = Number(fd.get("plan-count") || 1);

    // If manual and a specific cuota amount is provided, prefer it; else fall back to main 'amount'
    const perManual = Number(fd.get("existing-installment-amount"));
    let cuotaAmount = (!isNaN(perManual) && perManual !== 0)
      ? (amount >= 0 ? Math.abs(perManual) : -Math.abs(perManual))
      : amount; // use main amount field (already signed by txType)

    const tx = {
      ...common,
      date: d0,
      month: monthKeyFromDate(d0),
      amount: cuotaAmount,
      installmentPlan: { planId, count: cnt, index: idx, totalAmount: cuotaAmount * cnt, startDate: d0 }
    };
    await addDoc(collection(db, "transactions"), tx);
    showToast("Cuota agregada a plan existente");
  } else {
    // New plan: create N installments
    const n = Number(fd.get("installments-count"));
    if (!Number.isInteger(n) || n <= 0) throw new Error("Número de cuotas inválido");

    let per;        // signed per-installment amount
    let planTotal;  // signed total plan amount

    if (calc === "automatico") {
      // even split from the main amount
      per = Math.round(amount / n);
      planTotal = amount;
    } else {
      // manual: require per-installment; optional total plan
      const perInput = Number(fd.get("installment-amount"));
      if (isNaN(perInput) || perInput === 0) throw new Error("Monto por cuota (manual) es obligatorio");
      const totalInput = Number(fd.get("plan-total-amount"));
      const unsignedPer = Math.abs(perInput);
      per = (amount >= 0) ? unsignedPer : -unsignedPer; // keep sign consistent with Gasto/Ingreso

      if (!isNaN(totalInput) && totalInput !== 0) {
        planTotal = (amount >= 0) ? Math.abs(totalInput) : -Math.abs(totalInput);
      } else {
        planTotal = per * n; // infer from per * N (already signed)
      }
    }

    const planId = `${(fd.get("payee") || "plan")}-${Date.now()}`;
    for (let i = 0; i < n; i++) {
      const dt = addMonths(d0, i);
      const tx = {
        ...common,
        date: dt,
        month: monthKeyFromDate(dt),
        amount: per,
        installmentPlan: { planId, count: n, index: i + 1, totalAmount: planTotal, startDate: d0 }
      };
      await addDoc(collection(db, "transactions"), tx);
    }
    showToast("Plan en cuotas creado");
  }
} else {
  // single shot (unchanged)
  const tx = { ...common, date: d0, month: monthKeyFromDate(d0), amount };
  await addDoc(collection(db, "transactions"), tx);
  showToast("Transacción agregada");
}

        form.reset(); document.getElementById("date").valueAsDate=new Date();
        installmentsBox.style.display="none"; newPlanBox.style.display="block"; existingPlanBox.style.display="none"; planMode.value="nueva";
      }catch(e2){ alert(e2.message); }
    });

    /* === Permanentes / Sueldos adds === */
    document.getElementById("perm-add").addEventListener("click", async ()=>{
      const name=permName.value.trim(); const amt=Number(permAmount.value);
      if(!name || isNaN(amt)) return alert("Nombre y monto requeridos");
      try{
        await addDoc(collection(db,"permanents"), { uid:currentUser.uid, name, amount:-Math.abs(amt),
          category:permCategory.value||"Otros", createdAt:serverTimestamp() });
        permName.value=""; permAmount.value=""; showToast("Permanente agregado");
      }catch(e){ alert(e.message); }
    });
    salAddBtn.addEventListener("click", async ()=>{
      const name=salName.value.trim()||"Sueldo"; const amt=Number(salAmount.value);
      if(isNaN(amt)) return alert("Monto requerido");
      try{
        await addDoc(collection(db,"salaries"), { uid:currentUser.uid, name, amount:Math.abs(amt), payer:salPayer.value||"Miguelito", createdAt:serverTimestamp() });
        salName.value=""; salAmount.value=""; showToast("Sueldo agregado");
      }catch(e){ alert(e.message); }
    });

    /* === Savings tab === */
    document.getElementById("sav-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const owner=savOwner.value, type=savType.value;
      const amount=Number(savAmount.value); const date=new Date(savDate.value);
      if(isNaN(amount)||!isFinite(date)) return alert("Monto/Fecha inválidos");
      try{
        await addDoc(collection(db,"savings"), { uid:currentUser.uid, owner, type, amount, date, month:monthKeyFromDate(date), createdAt:serverTimestamp() });
        showToast("Ahorro registrado"); savAmount.value=""; savDate.value="";
      }catch(e2){ alert(e2.message); }
    });
    function renderSavingsTab(){
      const rows=[...savings].filter(r=>safeDate(r.date)).sort((a,b)=> safeDate(b.date)-safeDate(a.date) );
      savTable.innerHTML=`
        <div class="table-wrap"><table>
          <thead class="sticky-head"><tr><th>Fecha</th><th>Dueño</th><th>Tipo</th><th>Monto</th></tr></thead>
          <tbody>${rows.map(r=>{
            const d=safeDate(r.date); const ds=d? d.toISOString().slice(0,10) : "";
            const amt=Number(r.amount||0);
            return `<tr><td>${ds}</td><td>${r.owner}</td><td>${r.type}</td><td class="${amt<0?'neg':'pos'}">${fmt(amt)}</td></tr>`;
          }).join("")}</tbody></table></div>`;
      const sum=(w)=>rows.filter(x=>x.owner===w).reduce((s,x)=>s+Number(x.amount||0),0);
      const mig=sum("Miguelito"), jos=sum("Josefita"), con=sum("Conjunto"), total=mig+jos+con;
      savSummary.innerHTML=`
        <div class="kpis">
          <div class="kpi"><div class="kpi-label">Miguelito</div><div class="kpi-value">${fmt(mig)}</div></div>
          <div class="kpi"><div class="kpi-label">Josefita</div><div class="kpi-value">${fmt(jos)}</div></div>
          <div class="kpi"><div class="kpi-label">Conjunto</div><div class="kpi-value">${fmt(con)}</div></div>
          <div class="kpi"><div class="kpi-label"><b>Total Ahorros</b></div><div class="kpi-value">${fmt(total)}</div></div>
        </div>`;
    }

    /* === Monthly summary (last 3 months, robust + includes permanents/salaries) === */
    async function renderMonthlySummary(){
      if(!currentUser) return;
      try{
        const now=new Date();
        // Build target month keys: this month and previous 2
        const keys=[0,1,2].map(i=> monthKeyFromDate(new Date(now.getFullYear(), now.getMonth()-i, 1)) ).reverse();

        // Fetch all transactions (then filter by month key)
        const qs=await getDocs(query(collection(db,"transactions"), where("uid","==",currentUser.uid)));
        const txAll=[]; qs.forEach(d=>{
          const x=d.data(); const dt=safeDate(x.date); if(!dt) return;
          txAll.push({...x, _id:d.id, _dt:dt, _key:monthKeyFromDate(dt)});
        });

        monWrap.innerHTML=""; monStats.innerHTML="";
        const statCards=[];

        keys.forEach(key=>{
          // transactions for this key
          const arr=txAll.filter(x=>x._key===key);
          // add synthetic permanents + salaries for this key
          const mDate=firstDayOfMonthKey(key);
          const permRows = permanents.map(p=>({ amount:Number(p.amount)||0, category:p.category||"Otros", payee:p.name||"Permanente", _dt:mDate }));
          const salRows  = salaries.map(p=>({ amount:Math.abs(Number(p.amount)||0), category:"Sueldo", payee:p.name||"Sueldo", _dt:mDate }));
          const full = [...arr, ...permRows, ...salRows];

          // Category sums
          const byCat={};
          full.forEach(r=>{
            const c=r.category||"Otros"; const a=Number(r.amount)||0;
            byCat[c]=(byCat[c]||0)+a;
          });
          const catHtml = Object.entries(byCat)
            .sort((a,b)=>Math.abs(b[1])-Math.abs(a[1]))
            .map(([c,v])=>`<li><span>${c}</span><strong>${fmt(v)}</strong></li>`).join("");

          // Top expenses (largest negatives)
          const top = [...arr]                    // only transactions
          .filter(r => Number(r.amount) < 0)    // expenses
          .sort((a,b)=>Math.abs(Number(b.amount))-Math.abs(Number(a.amount)))
          .slice(0,3);
          const topHtml = top.map(r=>{
            const d = r._dt ? r._dt : safeDate(r.date);
            const ds = d? d.toISOString().slice(0,10) : "";
            // Try to show installment badge if present (only exists on tx docs)
            const src = (r.installmentPlan && r.installmentPlan.count) ? ` · cuota ${r.installmentPlan.index}/${r.installmentPlan.count}` : "";
            return `<li><span>${ds} · ${r.payee||"(sin descripción)"}${src}</span><strong class="neg">${fmt(r.amount)}</strong></li>`;
          }).join("");

          const card=document.createElement("div"); card.className="card";
          card.innerHTML=`
            <h3>${key} <span class="badge blue">Resumen mensual</span></h3>
            <div class="split">
              <div>
                <h4>Categorías (top)</h4>
                <ul class="toplist">${catHtml||"<li class='subtle'>Sin datos</li>"}</ul>
              </div>
              <div>
                <h4>Destacados (más costosos)</h4>
                <ul class="toplist">${topHtml||"<li class='subtle'>Sin datos</li>"}</ul>
              </div>
            </div>`;
          monWrap.appendChild(card);

          // stats
          const inc = full.filter(r=>Number(r.amount)>=0).reduce((s,x)=>s+Number(x.amount),0);
          const exp = full.filter(r=>Number(r.amount)<0).reduce((s,x)=>s+Math.abs(Number(x.amount)),0);
          statCards.push({inc,exp});
        });

        if(statCards.length){
          const avgInc = statCards.reduce((s,x)=>s+x.inc,0)/statCards.length;
          const avgExp = statCards.reduce((s,x)=>s+x.exp,0)/statCards.length;
          const avgBal = avgInc-avgExp;
          monStats.innerHTML=`
            <div class="stat-grid">
              <div class="card"><h3>Promedio Ingresos (3 meses)</h3><div class="kpi-value">${fmt(avgInc)}</div></div>
              <div class="card"><h3>Promedio Gastos (3 meses)</h3><div class="kpi-value">${fmt(-avgExp)}</div></div>
              <div class="card"><h3>Promedio Balance (3 meses)</h3><div class="kpi-value">${fmt(avgBal)}</div></div>
            </div>`;
        }
      }catch(err){
        console.error(err);
        monWrap.innerHTML = `<p class="subtle">No se pudo generar el resumen mensual.</p>`;
      }
    }

    /* === Installments analysis === */
    function renderInstallmentAnalysis(){
      // Only current month plans shown (keeps query light)
      const plans={};
      txRows.filter(r=>r.installmentPlan).forEach(r=>{
        const pid=r.installmentPlan.planId||`${r.payee||"plan"}`;
        (plans[pid]=plans[pid]||[]).push(r);
      });

      const keys=Object.keys(plans);
      if(!keys.length){ instWrap.innerHTML='<p class="subtle">No hay cuotas en el mes seleccionado.</p>'; return; }
      instWrap.innerHTML="";
      keys.forEach(pid=>{
        const arr=plans[pid].sort((a,b)=> (a.installmentPlan.index||0) - (b.installmentPlan.index||0));
        const any=arr[0], ip=any.installmentPlan;
        const count=ip.count||arr.length, last=arr[arr.length-1];
        const idx= last.installmentPlan.index||arr.length;
        const {pct,tone}=progressMeta(idx, count);
        const payer=any.payer||"", account=any.account||"", payee=any.payee||"";
        const per = Number(any.amount)||0;
        const total = per * count; // approx
        const left = count - idx;

        const itemsHtml = arr.map(x=>{
          const d = safeDate(x.date); const ds = d? d.toISOString().slice(0,10):"";
          return `<tr><td>${ds}</td><td>${fmt(x.amount)}</td><td>${x.account||""}</td><td>${x.payer||""}</td></tr>`;
        }).join("");

        const card=document.createElement("div"); card.className="card";
        card.innerHTML=`
          <h3>${payee} <span class="badge amber">${pid}</span></h3>
          <div class="row" style="margin:6px 0">
            <span class="i-chip ${tone}">Progreso ${idx}/${count}</span>
            <span class="progress"><span style="width:${pct}%"></span></span>
            <span class="badge">Restan ${left}</span>
            <span class="badge">Aprox total ${fmt(total)}</span>
            <span class="badge">Cuenta ${account||"-"}</span>
            <span class="badge">Pagador ${payer||"-"}</span>
          </div>
          <div class="table-wrap">
            <table>
              <thead class="sticky-head"><tr><th>Fecha</th><th>Monto</th><th>Pagador</th></tr></thead>
              <tbody>${itemsHtml}</tbody>
            </table>
          </div>`;
        instWrap.appendChild(card);
      });
    }

    async function refreshPlanOptions() {
      if (!currentUser || !existingPlanSelect) return;
      existingPlanSelect.innerHTML = "";
      const seen = new Map(); // planId -> label
      // You can use current month's txRows; for broader discovery, query all user's tx
      const qs = await getDocs(query(collection(db,"transactions"), where("uid","==",currentUser.uid)));
      qs.forEach(d=>{
        const t=d.data();
        const ip=t.installmentPlan;
        if(ip && ip.planId){
          const label = `${t.payee || "Plan"} · ${ip.index || "?"}/${ip.count || "?"}`;
          if(!seen.has(ip.planId)) seen.set(ip.planId, label);
        }
      });
      if (seen.size === 0) {
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="(No hay planes aún)";
        existingPlanSelect.appendChild(opt);
      } else {
        for (const [pid, label] of seen) {
          const opt=document.createElement("option");
          opt.value=pid; opt.textContent=label;
          existingPlanSelect.appendChild(opt);
        }
      }
    }


    /* === Init UI === */
    function initSelectors(){
      fillSelect(catSelect, CATS);
      fillSelect(payerSelect, PAYERS);
      fillSelect(permCategory, CATS);
      fillSelect(salPayer, PAYERS);
      fillSelect(savOwner, ["Miguelito","Josefita","Conjunto"]);
      fillSelect(savType, SAVING_TYPES);
      planMode.value="nueva"; newPlanBox.style.display="block"; existingPlanBox.style.display="none";
    }
    monthSelect.addEventListener("change", ()=>{
  subTx();
  renderSummaries();
  renderFinanceSavings();
  renderInstallmentAnalysis();
  renderMonthlySummary();
  renderMonthKpisAndChart();   // ← add this
});
    installmentsToggle.addEventListener("change", ()=>{ installmentsBox.style.display = installmentsToggle.checked ? "grid" : "none"; });
    planMode.addEventListener("change", ()=>{
      const m=planMode.value; newPlanBox.style.display = m==="nueva"?"block":"none"; existingPlanBox.style.display = m==="existente"?"block":"none";
    });

    onAuthStateChanged(auth,(user)=>{
      currentUser=user;
      if(!user){ show("login"); return; }
      show("dashboard");
      document.getElementById("date").valueAsDate=new Date();
      initSelectors(); populateMonths(); activateTab("fin");
      subTx(); subPerm(); subSal(); subSav(); refreshPlanOptions();
    });

    if(!firebaseConfig || !firebaseConfig.projectId){ authHelp.style.display="block"; }
  </script>
</head>
<body>
  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Login -->
  <div id="login-view" class="container" style="display:none">
    <div class="topbar">
      <h1>Home Finance Dashboard</h1>
      <span class="badge blue">Login</span>
    </div>
    <div class="card">
      <h2>Acceso</h2>
      <label>Email <input id="email" type="email" placeholder="you@example.com"></label>
      <label>Password <input id="password" type="password" placeholder="••••••••"></label>
      <div class="row">
        <button id="login-btn">Login</button>
        <button id="register-btn" class="secondary">Register</button>
      </div>
      <p id="auth-help" class="hint" style="display:none">Si ves pantalla en blanco, completa <code>firebase-config.js</code> y verifica que GitHub Pages sirva la carpeta con <code>index.html</code>.</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard-view" class="container" style="display:none">
    <div class="topbar">
      <h1>Home Finance Dashboard</h1>
      <div class="topbar-right">
        <span class="badge amber">Mes</span>
        <select id="month-select"></select>
        <div class="tabs">
          <button id="tab-fin" class="tab active">Finanzas</button>
          <button id="tab-sav" class="tab">Ahorros</button>
          <button id="tab-mon" class="tab">Resumen mensual</button>
          <button id="tab-inst" class="tab">Análisis cuotas</button>
        </div>
        <button id="logout-btn">Logout</button>
      </div>
    </div>

    <!-- FINANZAS -->
    <div id="page-fin" class="tabpage active">
      <div class="grid">
        <div class="grid-wide">
          <div class="card">
            <h3>Resumen del Mes
              <span class="badge blue">Ingresos</span>
              <span class="badge red">Gastos</span>
              <span class="badge green">Balance</span>
            </h3>
            <div class="kpis">
              <div class="kpi"><div class="kpi-label">Ingresos</div><div id="income" class="kpi-value">—</div></div>
              <div class="kpi"><div class="kpi-label">Gastos</div><div id="expense" class="kpi-value">—</div></div>
              <div class="kpi"><div class="kpi-label">Balance</div><div id="total" class="kpi-value">—</div></div>
            </div>
            <canvas id="catChart" height="120"></canvas>
            <canvas id="spendPie" height="120" style="margin-top:12px"></canvas>

          </div>

          <div class="card">
            <h3>Agregar Movimiento <span class="badge amber">rápido</span></h3>
            <form id="tx-form" class="form">
              <div class="split">
                <div>
                  <label>Fecha <input type="date" id="date" name="date" required></label>
                  <label>Tipo
                    <select id="tx-type" name="tx-type">
                      <option>Gasto</option>
                      <option>Ingreso</option>
                    </select>
                  </label>
                  <label>Monto <input type="number" step="1" name="amount" required></label>

                  <label>¿Con cuotas? <input type="checkbox" id="with-installments" name="with-installments"></label>
                        <div id="installments-box" class="installments" style="display:none">
                      <label>Modo
                        <select id="plan-mode" name="plan-mode">
                          <option value="nueva">Nueva</option>
                          <option value="existente">Existente</option>
                        </select>
                      </label>

                      <!-- NEW: calculation mode -->
                      <label>Cálculo
                        <select id="installments-calc" name="installments-calc">
                          <option value="automatico">Automático (divide total / N)</option>
                          <option value="manual">Manual (monto por cuota)</option>
                        </select>
                      </label>

                      <!-- New plan -->
                      <div id="new-plan-box">
                        <label>Número de cuotas
                          <input type="number" id="installments-count" name="installments-count" min="1" value="3">
                        </label>
                        <!-- NEW: manual fields (shown only if calc=manual) -->
                        <div id="manual-new-fields" style="display:none">
                          <label>Monto por cuota
                            <input type="number" id="installment-amount" name="installment-amount" placeholder="ej. 50000">
                          </label>
                          <label>Total del plan (opcional)
                            <input type="number" id="plan-total-amount" name="plan-total-amount" placeholder="se infiere = cuota * N">
                          </label>
                          <p class="hint">En modo manual, el monto por cuota es obligatorio; si no indicas total del plan, usaremos cuota*N.</p>
                        </div>
                        <p class="hint">En modo automático, se crearán N movimientos iguales (total/N) desde la fecha.</p>
                      </div>

                      <!-- Existing plan -->
                      <div id="existing-plan-box" style="display:none">
                      <label>Seleccionar plan
                        <select name="plan-id" id="existing-plan-select"></select>
                      </label>
                      <label>Cuota actual <input type="number" name="plan-index" min="1" value="1"></label>
                      <label>Total de cuotas <input type="number" name="plan-count" min="1" value="5"></label>

                      <!-- If manual calc, you can override the cuota amount -->
                      <div id="manual-existing-fields" style="display:none">
                        <label>Monto de la cuota
                          <input type="number" name="existing-installment-amount" id="existing-installment-amount" placeholder="si vacío, usa Monto de arriba">
                        </label>
                      </div>

                      <p class="hint">Se agregará solo la cuota actual al plan seleccionado.</p>
                    </div>
                    </div>

                </div>
                <div>
                  <label>Categoría
                    <select id="category" name="category"></select>
                  </label>
                  <label>Payee/Descripción <input type="text" name="payee" placeholder="Descripción del producto o servicio"></label>
                  <label>Pagador
                    <select id="payer" name="payer"></select>
                  </label>
                  <label>Notas <input type="text" name="notes" placeholder="comentarios"></label>
                </div>
              </div>
              <button type="submit">Guardar</button>
            </form>
          </div>

          <div class="card wide">
            <h3>Transacciones (click para editar → Guardar)</h3>
            <div class="table-wrap">
              <table>
                <thead class="sticky-head">
                  <tr><th>Fecha</th><th>Payee</th><th>Categoría</th><th>Monto</th><th>Pagador</th><th>Notas</th><th>Acciones</th></tr>
                </thead>
                <tbody id="tx-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="grid-wide">
          <div class="card">
            <h3>Gastos Permanentes <span class="badge red">siempre visibles</span></h3>
            <div id="perm-list"></div>
            <div class="hr"></div>
            <div class="row">
              <label style="flex:1">Nombre <input type="text" id="perm-name" placeholder="Arriendo, Internet, etc."></label>
              <label>Monto mensual (gasto) <input type="number" id="perm-amount" placeholder="ej. 350000"></label>
              <label>Categoría <select id="perm-category"></select></label>
              <button id="perm-add">Agregar permanente</button>
            </div>
          </div>

          <div class="card">
            <h3>Sueldos <span class="badge green">ingresos fijos</span></h3>
            <div id="sal-list"></div>
            <div class="hr"></div>
            <div class="row">
              <label style="flex:1">Nombre <input type="text" id="sal-name" placeholder="Sueldo Miguel/Jose"></label>
              <label>Monto mensual (ingreso) <input type="number" id="sal-amount" placeholder="ej. 1200000"></label>
              <label>Persona <select id="sal-payer"></select></label>
              <button id="sal-add">Agregar sueldo</button>
            </div>
          </div>

          <div class="card">
            <h3>Ahorros (solo lectura de la pestaña Ahorros) <span class="badge blue">mes actual</span></h3>
            <div id="finance-savings"></div>
          </div>

          <div class="card">
            <h3>Resumen por persona</h3>
            <div class="split">
              <div>
                <div id="sum-mig-no" class="details"></div>
                <div id="sum-mig-yes" class="details" style="margin-top:12px"></div>
                <div id="sum-perm-a" class="details" style="margin-top:12px"></div>
                <div id="sum-mig-mini" style="margin-top:12px"></div>
              </div>
              <div>
                <div id="sum-jos-no" class="details"></div>
                <div id="sum-jos-yes" class="details" style="margin-top:12px"></div>
                <div id="sum-perm-b" class="details" style="margin-top:12px"></div>
                <div id="sum-jos-mini" style="margin-top:12px"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Resumen Global</h3>
            <div id="global-summary"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- AHORROS -->
    <div id="page-sav" class="tabpage">
      <div class="card">
        <h3>Añadir movimiento de Ahorro <span class="badge amber">Fondos</span></h3>
        <form id="sav-form" class="row">
          <label>Dueño <select id="sav-owner"></select></label>
          <label>Tipo <select id="sav-type"></select></label>
          <label>Monto (+depósito / -retiro) <input type="number" id="sav-amount" required></label>
          <label>Fecha <input type="date" id="sav-date" required></label>
          <button type="submit">Guardar</button>
        </form>
      </div>
      <div class="card">
        <h3>Resumen Ahorros</h3>
        <div id="sav-summary"></div>
      </div>
      <div class="card">
        <h3>Movimientos</h3>
        <div id="sav-table"></div>
      </div>
    </div>

    <!-- RESUMEN MENSUAL -->
    <div id="page-mon" class="tabpage">
      <div class="card">
        <h3>Últimos 3 meses</h3>
        <div id="monthly-wrap" class="month-grid"></div>
      </div>
      <div class="card">
        <h3>Promedios</h3>
        <div id="monthly-stats"></div>
      </div>
    </div>

    <!-- ANÁLISIS CUOTAS -->
    <div id="page-inst" class="tabpage">
      <div id="inst-wrap"></div>
    </div>

  </div>
</body>
</html>
